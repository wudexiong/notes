<!--
 * @Author: WuDeXiong
 * @Date: 2022-10-18 20:13:07
 * @LastEditors: OBKoro1
 * @LastEditTime: 2022-10-18 20:31:09
 * @FilePath: \notes\project\onlinePhoto\index.html
 * @Description: 
 * 
 * Copyright (c) 2022 by WuDeXiong, All Rights Reserved. 
-->
<!DOCTYPE html>

<html>
  <head>
    <script src="https://www.jq22.com/jquery/jquery-3.3.1.js"></script>
    <title>最简拍照功能</title>
  </head>

  <body>
    <a
      href="javascript:;"
      class="btn btn-success btn-add"
      title="拍照"
      id="webcam"
      >拍照</a
    >

    <video
      id="webcam2"
      style="display: none"
      class="src-video"
      width="500px"
      height="500px"
      autoplay="autoplay"
    ></video>

    <canvas
      id="canvas"
      width="1000px"
      height="500px"
      style="display: none"
    ></canvas>

    <img src="" alt="" class="photo" />

    <script>
      var srcVideo = document.querySelector("video.src-video");

      var mediaStream;

      var photo = document.querySelector("img.photo");

      // 开启摄像头

      $("#webcam").click(function () {
        photo.src = "";

        srcVideo.style.display = "block";

        var constraints = {
          audio: false, //音频轨道

          video: { width: 1000, height: 500 }, //视频轨道
        };

        var mediaPromise = navigator.mediaDevices.getUserMedia(constraints);

        mediaPromise
          .then(function (stream) {
            /* 使用这个stream stream */

            mediaStream = stream;

            srcVideo.srcObject = stream;

            srcVideo.play();
          })
          .catch(function (err) {
            /* 处理error */

            console.log(err);
          });
      });
      function photograph() {
        var canvas = document.querySelector("#canvas");

        //获取 `canvas`元素，根据`srcVideo`中的数据进行图片绘制 `ctx.drawImage()`；

        var ctx = canvas.getContext("2d");

        ctx.drawImage(srcVideo, 0, 0, 1000, 500);

        //将 `canvas`绘制的图片信息，展示在 `img`标签中；

        photo.src = canvas.toDataURL();

        // $("#c-image").val(canvas.toDataURL());

        // Upload.api.send();

        var alink = document.createElement("a");

        alink.href = photo.src;

        alink.download = Math.random() + ".png";

        alink.click();

        /* 此为百度文字识别OCR

        $.ajax({

        header:{"Content-Type":"application/x-www-form-urlencoded"},

        url:"https://aip.baidubce.com/rest/2.0/ocr/v1/accurate_basic",

        async:true,

        type:"post",

        data:{

            access_token:"你自己的access_token",

            image:photo.src,

        },

        dataType:"json",

        success:function (res) {

        console.log(res.words_result_num);

        console.log(res.words_result[0].words);

        var words = "";

        for(var i=0;i<res.words_result_num;i++){

        words+=res.words_result[i].words;

        }

        console.log(words);

        }

        });

        */

        closeMedia();
      }
      $("#webcam2").click(photograph);
      
      var closeMedia = function () {
        mediaStream.getTracks().forEach((track) => {
          track.stop();
        });

        srcVideo.style.display = "none";
      };
    </script>
  </body>
</html>
